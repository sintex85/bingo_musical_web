<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bingo Musical</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="flex flex-col justify-center items-center min-h-screen p-4">
    <div id="message-box" class="rounded-lg shadow-lg"></div>

    <!-- Role selection removed -->

    <div id="admin-panel" class="container w-full max-w-2xl mx-auto hidden">
      <h1>Panel de Administración</h1>
      <div id="create-session-section">
        <label for="playlist-url" class="block text-lg mb-2"
          >Enlace de Playlist Pública de Spotify:</label
        >
        <input
          type="text"
          id="playlist-url"
          class="form-input mb-4"
          placeholder="Ej: https://open.spotify.com/playlist/..."
        />
        <button id="create-session-btn" class="btn">
          <i class="fas fa-play"></i> Iniciar Nueva Sesión
        </button>
      </div>

      <div id="session-info" class="hidden mt-6">
        <p class="text-lg font-bold mb-2">
          ID de Sesión: <span id="session-id-display"></span>
        </p>
        <p class="text-lg mb-4">
          Comparte este enlace para que los jugadores se unan:
        </p>
        <a
          id="join-link"
          href="#"
          target="_blank"
          class="text-blue-200 hover:underline text-lg font-medium mb-4 block overflow-hidden text-ellipsis whitespace-nowrap"
        ></a>
        <div id="qrcode" class="qr-code-container mx-auto"></div>

        
        
      </div>
    </div>

    <div id="player-view" class="container w-full max-w-3xl mx-auto hidden">
      <h1>Tu Cartón de Bingo</h1>
      <div id="join-session-section">
        <label for="join-session-id" class="block text-lg mb-2"
          >Introduce ID de Sesión:</label
        >
        <input
          type="text"
          id="join-session-id"
          class="form-input mb-4"
          placeholder="ID de sesión"
        />
        <button id="join-session-btn" class="btn btn-green">
          <i class="fas fa-sign-in-alt"></i> Unirse a Sesión
        </button>
      </div>

      <div id="game-area" class="hidden">
        <div id="bingo-card" class="bingo-card mb-6">
          <!-- Celdas del cartón de bingo se insertarán aquí -->
        </div>
        <div class="game-status mt-4">
          <p>Canciones Marcadas: <span id="marked-count">0</span> / 20</p>
          <p>Líneas Completadas: <span id="lines-count">0</span></p>
        </div>
        <div
          id="win-message"
          class="mt-4 text-2xl font-bold text-yellow-300 hidden"
        >
          ¡BINGO!
        </div>
      </div>
    </div>

    <!-- Mueve los scripts de las librerías al final del body -->
    <!-- Incluye el cliente de Socket.IO del propio servidor antes de usar io() -->
    <!-- Se usa un CDN para Socket.IO para mayor fiabilidad en la carga -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
      // Función para mostrar mensajes temporales al usuario
      function showMessage(message, type = "error") {
        const msgBox = document.getElementById("message-box");
        msgBox.textContent = message;
        msgBox.className = "rounded-lg shadow-lg show"; // Restablece clases y añade 'show'
        if (type === "success") {
          msgBox.style.backgroundColor = "rgba(76, 175, 80, 0.95)"; // Verde para éxito
        } else if (type === "info") {
          msgBox.style.backgroundColor = "rgba(33, 150, 243, 0.95)"; // Azul para información
        } else {
          msgBox.style.backgroundColor = "rgba(230, 57, 70, 0.95)"; // Rojo para error
        }

        setTimeout(() => {
          msgBox.classList.remove("show");
        }, 3000);
      }

      let socket; // Declara la variable socket globalmente para este script

      // Este bloque se ejecuta tan pronto como este script se parsea,
      // después de que socket.io.js ha sido cargado.
      if (typeof io === "undefined") {
        showMessage(
          "Error crítico: El cliente de Socket.IO no se ha cargado correctamente. Por favor, revisa la conexión de red y la configuración del servidor.",
          "error"
        );
        console.error(
          "El objeto 'io' de Socket.IO es indefinido. No se puede continuar con la funcionalidad de Socket.IO."
        );
        // No se inicializa 'socket' y el resto de la lógica dependiente de 'socket'
        // en DOMContentLoaded deberá manejar 'socket' como indefinido.
      } else {
        socket = io(window.location.origin, { transports: ["polling"] }); // Solo long‑polling en producción.
      }

      // Envuelve el resto de la lógica en DOMContentLoaded para asegurar que los elementos HTML existen
      window.addEventListener("DOMContentLoaded", () => {
        socket.emit('setRole', { role: 'admin' });
        // Si 'socket' no se pudo inicializar (porque 'io' no estaba definido), no continuar con la lógica que lo usa
        if (typeof socket === "undefined") {
          console.error(
            "Socket no se inicializó correctamente en DOMContentLoaded. Abortando lógica dependiente del DOM."
          );
          // Retorna para evitar errores en cascada.
          return;
        }

        let currentSessionId = null;
        let userId = null; // Generado en el lado del cliente para cada jugador que se une a una sesión
        let currentBingoCard = []; // Almacena el cartón de bingo del jugador

        const adminPanelDiv = document.getElementById("admin-panel");
        const playerViewDiv = document.getElementById("player-view");

        const createSessionBtn = document.getElementById("create-session-btn");
        const playlistUrlInput = document.getElementById("playlist-url");
        const sessionIdDisplay = document.getElementById("session-id-display");
        const joinLink = document.getElementById("join-link");
        const qrcodeDiv = document.getElementById("qrcode");
        const sessionInfoDiv = document.getElementById("session-info");
        

        const joinSessionIdInput = document.getElementById("join-session-id");
        const joinSessionBtn = document.getElementById("join-session-btn");
        const gameAreaDiv = document.getElementById("game-area");
        const bingoCardDiv = document.getElementById("bingo-card");
        const markedCountSpan = document.getElementById("marked-count");
        const linesCountSpan = document.getElementById("lines-count");
        const winMessageDiv = document.getElementById("win-message");

        // --- Lógica de Selección de Rol eliminada (admin/usuario) ---

        // --- Lógica de Admin ---
        createSessionBtn.addEventListener("click", () => {
          const playlistUrl = playlistUrlInput.value.trim();
          if (playlistUrl) {
            showMessage("Creando sesión y obteniendo playlist...", "info");
            socket.emit("createSession", { playlistUrl });
          } else {
            showMessage("Por favor, introduce una URL de playlist válida.");
          }
        });

        socket.on("sessionCreated", ({ sessionId, joinUrl }) => {
          currentSessionId = sessionId;
          sessionIdDisplay.textContent = sessionId;
          joinLink.href = joinUrl;
          joinLink.textContent = joinUrl;
          sessionInfoDiv.classList.remove("hidden");
          showMessage(
            "Sesión creada con éxito. Comparte el enlace.",
            "success"
          );

          // Generar código QR
          new QRCode(qrcodeDiv, {
            text: joinUrl,
            width: 128,
            height: 128,
            colorDark: "#1d3557",
            colorLight: "#f1faee",
            correctLevel: QRCode.CorrectLevel.H,
          });
        });

        socket.on("sessionError", (message) => {
          showMessage(message);
        });



        joinSessionBtn.addEventListener("click", () => {
          const sid = joinSessionIdInput.value.trim();
          if (sid) {
            // Generar un ID de usuario único para este jugador
            userId = "player_" + Math.random().toString(36).substring(2, 9);
            showMessage(`Uniéndote a la sesión ${sid}...`, "info");
            socket.emit("joinSession", { sessionId: sid, userId: userId });
          } else {
            showMessage("Por favor, introduce un ID de sesión.");
          }
        });

        socket.on("sessionJoined", ({ sessionId, bingoCard }) => {
            currentSessionId = sessionId;
            // Asegurarnos de que el cartón solo tenga 20 celdas
            currentBingoCard = bingoCard.slice(0, 20);
            document.getElementById("join-session-section").classList.add("hidden");
            gameAreaDiv.classList.remove("hidden");
            renderBingoCard(currentBingoCard);
            updatePlayerStats();
            showMessage(`Te has unido a la sesión ${sessionId}. ¡Que empiece el juego!`, "success");
            });

        socket.on(
          "updateBingoCard",
          ({ markedCells, linesCompleted, isBingo, userId: updatedUserId }) => {
            if (updatedUserId === userId) {
              // Solo actualiza si es para este jugador
              renderBingoCard(currentBingoCard); // Vuelve a renderizar para actualizar el estado marcado
              updatePlayerStats();

              if (isBingo) {
                winMessageDiv.classList.remove("hidden");
                showMessage("¡BINGO! Has ganado.", "success");
              } else {
                winMessageDiv.classList.add("hidden");
              }
            }
          }
        );



        function renderBingoCard(card) {
            bingoCardDiv.innerHTML = "";
            card.forEach(song => {
                const cell = document.createElement("div");
                cell.classList.add("bingo-cell");
                cell.innerHTML = `
                <p class="font-bold">${song.title}</p>
                <p class="text-sm">${song.artist}</p>
                `;
                cell.addEventListener("click", () => {
                cell.classList.toggle("marked");
                updatePlayerStats();
                });
                bingoCardDiv.appendChild(cell);
            });
            }

        function updatePlayerStats() {
            const cells = bingoCardDiv.querySelectorAll(".bingo-cell");
            const totalCells = cells.length;       // should be 20
            const totalMarked = [...cells].filter(c => c.classList.contains("marked")).length;
            markedCountSpan.textContent = `${totalMarked} / ${totalCells}`;

            // LINEA once you have 5 or more marked (but less than full card)
            const hasLine = totalMarked >= 5 && totalMarked < totalCells;
            linesCountSpan.textContent = hasLine ? 1 : 0;

            if (totalMarked === totalCells) {
                // BINGO when all are marked
                winMessageDiv.textContent = "¡BINGO!";
                winMessageDiv.classList.remove("hidden");
                showMessage("¡BINGO! Has completado todas las canciones.", "success");
            } else if (hasLine) {
                // LINEA when at least 5 marked
                winMessageDiv.textContent = "¡LÍNEA!";
                winMessageDiv.classList.remove("hidden");
                showMessage(`¡LÍNEA! Has marcado ${totalMarked} canciones.`, "info");
            } else {
                winMessageDiv.classList.add("hidden");
            }
        }
      // Decide vista según presence de sid en la URL
      const initSid = new URLSearchParams(window.location.search).get("sid");
      if (initSid) {
          // Modo jugador
          socket.emit('setRole', { role: 'player' });
          adminPanelDiv.classList.add('hidden');
          playerViewDiv.classList.remove('hidden');
          // Generar un ID de jugador e unirse automáticamente
          userId = 'player_' + Math.random().toString(36).substring(2, 9);
          socket.emit('joinSession', { sessionId: initSid, userId });
      } else {
          // Modo administrador
          socket.emit('setRole', { role: 'admin' });
          adminPanelDiv.classList.remove('hidden');
          playerViewDiv.classList.add('hidden');
      }
      }); // Fin del listener de DOMContentLoaded
    </script>
  </body>
</html>
